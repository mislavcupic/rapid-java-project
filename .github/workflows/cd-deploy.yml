#name: 02 - CD: Deployment to Prototype

on:
  workflow_dispatch:
  push:
    branches:
      - develop
      - main

jobs:
  deploy:
    name: Deploy App
    # 1. PROMJENA: Ciljanje Vašeg laptopa (mislav007)
    runs-on: [self-hosted, linux, mislav007]

    environment: Prototype
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. PROMJENA: UKLONJEN BLOK 'Configure SSH'

      - name: Deploy via Podman Compose
        env:
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_TAG: ${{ github.sha }}
          # PROD TAJNE VRIJEDNOSTI IZ GITHUB SECRETS-a
          PROD_DB_USER: ${{ secrets.PROD_DB_USER }}
          PROD_DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
          PROD_DB_NAME: ${{ secrets.PROD_DB_NAME }}

        run: |
          # 3. PROMJENA: SSH wrapper i nepotrebna cd putanja su uklonjeni.
          
          # Prijava na GHCR
          echo ${{ env.GHCR_TOKEN }} | podman login ghcr.io -u $USER --password-stdin
          
          # EXPORT TAJNIH VARIJABLI
          export DB_USER=${{ env.PROD_DB_USER }}
          export DB_PASSWORD=${{ env.PROD_DB_PASSWORD }}
          export DB_NAME=${{ env.PROD_DB_NAME }}
          
          # Ažuriranje image tagova u docker-compose.yml (zamjenjuje :latest sa SHA)
          sed -i "s|backend:.*|backend:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          sed -i "s|frontend:.*|frontend:${{ env.IMAGE_TAG }}|g" docker-compose.yml
          
          # Povlačenje i deployment
          echo "Povlačenje novih slika..."
          podman compose pull
          echo "Pokretanje deploymenta s Podman Compose..."
          podman compose up -d --force-recreate
          
          echo "Deployment dovršen."