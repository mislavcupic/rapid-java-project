-- DDL za bazu podataka (Definicija Sheme)
-- NAPOMENA: Ovaj dio bi trebao biti u schema.sql, ali ga ostavljam radi kompletnosti ako se baza ne inicijalizira.

-- 1. Tablica za Korisnike (Users)
CREATE TABLE IF NOT EXISTS app_user (
                                        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                        first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255) NOT NULL,
    username VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    is_enabled BOOLEAN DEFAULT TRUE
    );

-- 2. Tablica za Uloge (Roles)
CREATE TABLE IF NOT EXISTS roles (
                                     id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                     name VARCHAR(255) NOT NULL UNIQUE
    );

-- 3. Vezna tablica M:N za korisnike i uloge
CREATE TABLE IF NOT EXISTS user_roles (
                                          application_user_id BIGINT NOT NULL,
                                          role_id BIGINT NOT NULL,
                                          PRIMARY KEY (application_user_id, role_id),

    FOREIGN KEY (application_user_id) REFERENCES app_user(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE
    );

-- 4. Tablica za Vozila (Vehicle)
CREATE TABLE IF NOT EXISTS vehicle (
                                       id BIGSERIAL PRIMARY KEY,
                                       license_plate VARCHAR(20) UNIQUE NOT NULL,
    make VARCHAR(50) NOT NULL,
    model VARCHAR(50) NOT NULL,
    model_year INTEGER,
    fuel_type VARCHAR(20),
    load_capacity_kg DECIMAL(10, 2),

    current_driver_id BIGINT UNIQUE,
    FOREIGN KEY (current_driver_id) REFERENCES app_user(id) ON DELETE SET NULL
    );

-- 5. Tablica za Osvježavanje Tokena (JWT) - Pretpostavljam da je u schema.sql, ali dodano radi kompletnosti
CREATE TABLE IF NOT EXISTS refresh_token (
                                             id BIGSERIAL PRIMARY KEY,
                                             user_id BIGINT NOT NULL UNIQUE,
                                             token VARCHAR(255) UNIQUE NOT NULL,
    expiry_date TIMESTAMP WITHOUT TIME ZONE NOT NULL,
    FOREIGN KEY (user_id) REFERENCES app_user(id) ON DELETE CASCADE
    );


---------------------------------------------------
-- PODACI (DATA)
---------------------------------------------------

-- Čišćenje tablica prije unosa (ako koristite H2, HSQLDB)
DELETE FROM user_roles;
DELETE FROM vehicle;
DELETE FROM roles;
DELETE FROM app_user;
-- ⚠️ NAPOMENA: Ako koristite PostgreSQL, možda ćete morati resetirati sekvence
-- PRIMJER: ALTER SEQUENCE app_user_id_seq RESTART WITH 1;

-- A. Unos Uloga (roles)
INSERT INTO roles (id, name) VALUES (1, 'ROLE_ADMIN');
INSERT INTO roles (id, name) VALUES (2, 'ROLE_MANAGER');
INSERT INTO roles (id, name) VALUES (3, 'ROLE_DRIVER');

-- B. Unos Korisnika (app_user) - Lozinka je BCrypt hash za 'password'
INSERT INTO app_user (id, first_name, last_name, username, password, email, is_enabled) VALUES
    (1, 'Admin', 'Korisnik', 'admin', '$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW', 'admin@fleet.io', TRUE);

INSERT INTO app_user (id, first_name, last_name, username, password, email, is_enabled) VALUES
    (2, 'Petar', 'Petrović', 'manager', '$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW', 'petar@fleet.io', TRUE);

INSERT INTO app_user (id, first_name, last_name, username, password, email, is_enabled) VALUES
    (3, 'Ivo', 'Ivić', 'ivo.ivic', '$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW', 'ivo@fleet.io', TRUE);

INSERT INTO app_user (id, first_name, last_name, username, password, email, is_enabled) VALUES
    (4, 'Marko', 'Marić', 'marko.maric', '$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW', 'marko@fleet.io', TRUE);


-- C. Povezivanje Korisnika i Uloga (user_roles)
INSERT INTO user_roles (application_user_id, role_id) VALUES (1, 1); -- Admin
INSERT INTO user_roles (application_user_id, role_id) VALUES (2, 2); -- Manager
INSERT INTO user_roles (application_user_id, role_id) VALUES (3, 3); -- Vozač 1
INSERT INTO user_roles (application_user_id, role_id) VALUES (4, 3); -- Vozač 2


-- D. Unos Vozila (Vehicle) - Dodavanje vozača radi testiranja
INSERT INTO vehicle (license_plate, make, model, model_year, fuel_type, load_capacity_kg, current_driver_id) VALUES
    ('ZG1234AB', 'MAN', 'TGX', 2021, 'Diesel', 24000.00, 3); -- Vozilo vozi Ivo Ivić

INSERT INTO vehicle (license_plate, make, model, model_year, fuel_type, load_capacity_kg, current_driver_id) VALUES
    ('ST5678CD', 'Volvo', 'FH16', 2023, 'HVO', 25000.00, 4); -- Vozilo vozi Marko Marić

INSERT INTO vehicle (license_plate, make, model, model_year, fuel_type, load_capacity_kg, current_driver_id) VALUES
    ('RI9012EF', 'Renault', 'T-Series', 2020, 'Diesel', 20000.00, NULL); -- Vozilo bez vozača